<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>RSocket JS Client</title>
    <script src="https://unpkg.com/rsocket-core@0.0.27/dist/rsocket-core.min.js"></script>
    <script src="https://unpkg.com/rsocket-websocket-client@0.0.27/dist/rsocket-websocket-client.min.js"></script>
</head>
<body>
<h1>RSocket Test</h1>
<button id="sendRequest">Enviar mensaje al backend</button>

<script>
    const { RSocketClient, JsonSerializer, IdentitySerializer } = window.rsocketCore;
    const { RSocketWebSocketClient } = window.rsocketWebSocketClient;

    const client = new RSocketClient({
        serializers: {
            data: JsonSerializer,
            metadata: IdentitySerializer
        },
        setup: {
            keepAlive: 60000,
            lifetime: 180000,
            dataMimeType: 'application/json',
            metadataMimeType: 'message/x.rsocket.routing.v0'
        },
        transport: new RSocketWebSocketClient({ url: 'ws://localhost:7000/rsocket' })
    });

    // Helper para crear el metadata con routing
    function encodeRoute(route) {
        const length = String.fromCharCode(route.length);
        return length + route;
    }

    document.getElementById('sendRequest').addEventListener('click', () => {
        client.connect().subscribe({
            onComplete: socket => {
                socket.requestResponse({
                    data: {
                        plantacion_id : '682230e449add36ebeaac933',
                        sensor_id: '6822318bbcd9906adbdf3aa8'
                    },
                    metadata: encodeRoute('sensor.values') // ruta mapeada en el backend
                }).subscribe({
                    onComplete: payload => {
                        console.log('Respuesta del servidor:', payload.data);
                        alert('Respuesta: ' + JSON.stringify(payload.data));
                    },
                    onError: error => {
                        console.error('Error en la respuesta:', error);
                        alert('Error: ' + error.message);
                    }
                });
            },
            onError: error => {
                console.error('Error al conectar con el servidor RSocket:', error);
                alert('No se pudo conectar con el backend RSocket');
            }
        });
    });
</script>
</body>
</html>